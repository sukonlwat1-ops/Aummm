<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Space Adventure (Rules Added)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, serverTimestamp, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyB1OQteZ7lo4N2wiFLVGULea152pUk1kp4",
            authDomain: "myspacegame-6b940.firebaseapp.com",
            projectId: "myspacegame-6b940",
            storageBucket: "myspacegame-6b940.firebasestorage.app",
            messagingSenderId: "67671889390",
            appId: "1:67671889390:web:580f7459c792a88b10eaff",
            measurementId: "G-ZKLW04NJ6Q"
        };

        // --- SETUP ---
        let db, auth;
        const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'space-adventure-default';

        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) { console.error(e); }

        // ‡∏™‡∏∏‡πà‡∏° ID ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏≠‡πÅ‡∏¢‡∏Å‡πÑ‡∏î‡πâ) ‡πÅ‡∏ï‡πà‡∏à‡∏∞‡∏à‡∏≥‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ
        const myPlayerId = "player_" + Math.random().toString(36).substr(2, 9);
        let currentRoomId = null;
        let gameState = null;
        let unsubscribe = null;

        // --- INIT ---
        async function initGame() {
            try {
                await signInAnonymously(auth);
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('lobby-screen').style.display = 'flex';
                
                // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏à‡∏≥‡πÑ‡∏ß‡πâ‡∏°‡∏≤‡πÉ‡∏™‡πà
                const savedName = localStorage.getItem('space_adventure_username');
                if (savedName) {
                    document.getElementById('p-name-input').value = savedName;
                }
                
                console.log("My ID:", myPlayerId);
            } catch (e) {
                alert("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: " + e.message);
            }
        }
        window.onload = initGame;

        // --- HELPER ---
        const getRoomRef = (rid) => doc(db, "rooms", rid);
        const getGlobalScoreRef = () => collection(db, 'artifacts', appId, 'public', 'data', 'global_scores');

        // --- ACTIONS ---
        window.createRoom = async () => {
            const nameInput = document.getElementById('p-name-input');
            const name = nameInput.value.trim();
            
            // 1. ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠
            if (!name) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏Ñ‡∏£‡∏±‡∏ö!");
                nameInput.focus();
                nameInput.classList.add('ring-4', 'ring-red-500'); // ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                setTimeout(() => nameInput.classList.remove('ring-4', 'ring-red-500'), 2000);
                return;
            }

            // ‡∏à‡∏≥‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
            localStorage.setItem('space_adventure_username', name);

            const btn = document.getElementById('create-btn');
            btn.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á...'; btn.disabled = true;

            const roomId = Math.random().toString(36).substring(2, 6).toUpperCase();
            const difficulty = document.getElementById('diff-select').value;

            const roomData = {
                hostId: myPlayerId,
                status: 'waiting',
                difficulty: difficulty,
                winnerId: null,
                players: [{
                    id: myPlayerId,
                    name: name,
                    pos: 1,
                    color: '#facc15',
                    score: 0
                }],
                turnIndex: 0,
                lastAction: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                createdAt: serverTimestamp()
            };

            try {
                await setDoc(getRoomRef(roomId), roomData);
                enterRoom(roomId);
            } catch (e) {
                alert("‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: " + e.message);
                btn.innerHTML = '<i class="fas fa-plus mr-1"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á'; btn.disabled = false;
            }
        };

        window.joinRoom = async () => {
            const nameInput = document.getElementById('p-name-input');
            const name = nameInput.value.trim();
            const roomId = document.getElementById('room-code-input').value.trim().toUpperCase();

            // 1. ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠
            if (!name) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏Ñ‡∏£‡∏±‡∏ö!");
                nameInput.focus();
                return;
            }
            
            if (!roomId) return alert("‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö");

            const btn = document.getElementById('join-btn');
            btn.innerHTML = '‚è≥'; btn.disabled = true;

            try {
                const roomRef = getRoomRef(roomId);
                const snap = await getDoc(roomRef);

                if (!snap.exists()) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ");
                const data = snap.data();

                // 2. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥ (‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏´‡πâ‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô)
                const isNameTaken = data.players.some(p => p.name === name && p.id !== myPlayerId);
                if (isNameTaken) {
                    throw new Error(`‡∏ä‡∏∑‡πà‡∏≠ "${name}" ‡∏°‡∏µ‡∏Ñ‡∏ô‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà`);
                }

                // ‡∏à‡∏≥‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ
                localStorage.setItem('space_adventure_username', name);

                const isAlreadyIn = data.players.find(p => p.id === myPlayerId);
                
                if (!isAlreadyIn) {
                    if (data.status !== 'waiting') throw new Error("‡πÄ‡∏Å‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß");
                    if (data.players.length >= 4) throw new Error("‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß");

                    const colors = ['#facc15', '#ef4444', '#3b82f6', '#22c55e'];
                    const newPlayer = {
                        id: myPlayerId,
                        name: name,
                        pos: 1,
                        color: colors[data.players.length] || '#fff',
                        score: 0
                    };
                    
                    await updateDoc(roomRef, { 
                        players: [...data.players, newPlayer] 
                    });
                }
                
                enterRoom(roomId);

            } catch (e) {
                alert(e.message);
                btn.innerHTML = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°'; btn.disabled = false;
            }
        };

        function enterRoom(roomId) {
            if (unsubscribe) unsubscribe();

            currentRoomId = roomId;
            document.getElementById('lobby-screen').style.display = 'none';
            document.getElementById('game-room').style.display = 'flex';
            document.getElementById('room-id-disp').innerText = roomId;

            unsubscribe = onSnapshot(getRoomRef(roomId), (doc) => {
                if (doc.exists()) {
                    gameState = doc.data();
                    renderGame(gameState);
                } else {
                    alert("‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß");
                    leaveRoom();
                }
            });
        }

        window.leaveRoom = () => {
            if (unsubscribe) unsubscribe();
            unsubscribe = null;
            currentRoomId = null;
            gameState = null;

            document.getElementById('game-room').style.display = 'none';
            document.getElementById('leaderboard-modal').style.display = 'none';
            document.getElementById('global-lb-modal').style.display = 'none';
            document.getElementById('rules-modal').style.display = 'none';
            document.getElementById('lobby-screen').style.display = 'flex';
            
            document.getElementById('create-btn').innerHTML = '<i class="fas fa-plus mr-1"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á';
            document.getElementById('create-btn').disabled = false;
            document.getElementById('join-btn').innerHTML = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°';
            document.getElementById('join-btn').disabled = false;
        };

        window.startGameHost = async () => {
            if (!gameState || gameState.hostId !== myPlayerId) return;
            try {
                await updateDoc(getRoomRef(currentRoomId), { status: 'playing' });
            } catch (e) {
                alert("‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: " + e.message);
            }
        };

        window.resetGameHost = async () => {
            if (!gameState || gameState.hostId !== myPlayerId) return;
            const resetPlayers = gameState.players.map(p => ({...p, pos: 1, score: 0}));
            try {
                await updateDoc(getRoomRef(currentRoomId), { 
                    status: 'waiting',
                    players: resetPlayers,
                    turnIndex: 0,
                    winnerId: null,
                    lastAction: '‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏Å‡∏°‡πÅ‡∏•‡πâ‡∏ß'
                });
            } catch (e) {
                alert("‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: " + e.message);
            }
        };

        // --- RULES LOGIC ---
        window.openRules = () => {
            document.getElementById('rules-modal').style.display = 'flex';
        };

        window.closeRules = () => {
            document.getElementById('rules-modal').style.display = 'none';
        };

        // --- GLOBAL LEADERBOARD LOGIC ---
        window.viewGlobalRankings = async () => {
            const list = document.getElementById('global-lb-list');
            const filterDiff = document.getElementById('gl-diff-filter').value;
            
            list.innerHTML = '<div class="text-center text-slate-400 py-4"><i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>';
            document.getElementById('global-lb-modal').style.display = 'flex';

            try {
                const querySnapshot = await getDocs(getGlobalScoreRef());
                let scores = [];
                querySnapshot.forEach((doc) => {
                    const d = doc.data();
                    if (filterDiff === 'all' || d.difficulty === filterDiff) {
                        scores.push(d);
                    }
                });

                scores.sort((a, b) => b.score - a.score);
                scores = scores.slice(0, 10);

                list.innerHTML = '';
                if (scores.length === 0) {
                    list.innerHTML = '<div class="text-center text-slate-500 py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏Å‡∏•‡πâ‡∏≤‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ</div>';
                    return;
                }

                scores.forEach((s, idx) => {
                    let rank = idx + 1;
                    let rankIcon = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : `<span class="text-slate-500 text-sm font-bold w-6 inline-block text-center">#${rank}</span>`;
                    let colorClass = rank === 1 ? 'border-yellow-500 bg-yellow-900/10' : 'border-slate-700 bg-slate-800';
                    let diffBadge = '';
                    
                    if (filterDiff === 'all' && s.difficulty) {
                        const badgeColor = s.difficulty === 'easy' ? 'bg-green-500/20 text-green-400' : s.difficulty === 'medium' ? 'bg-yellow-500/20 text-yellow-400' : 'bg-red-500/20 text-red-400';
                        diffBadge = `<span class="text-[9px] px-1.5 py-0.5 rounded ml-2 ${badgeColor}">${s.difficulty.toUpperCase()}</span>`;
                    }

                    list.innerHTML += `
                        <div class="flex items-center justify-between p-3 rounded-lg border ${colorClass} mb-2">
                            <div class="flex items-center gap-3">
                                <span class="text-xl">${rankIcon}</span>
                                <div>
                                    <span class="text-white font-bold">${s.name}</span>
                                    ${diffBadge}
                                </div>
                            </div>
                            <span class="text-cyan-400 font-mono font-bold">${s.score} pts</span>
                        </div>
                    `;
                });

            } catch (e) {
                console.error(e);
                list.innerHTML = '<div class="text-center text-red-400 py-4">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>';
            }
        };

        window.closeGlobalLb = () => {
            document.getElementById('global-lb-modal').style.display = 'none';
        };

        // --- IN-GAME RANKING LOGIC ---
        window.viewRankings = () => {
            if (gameState) {
                showLeaderboard(gameState, gameState.hostId === myPlayerId, true);
            }
        };

        window.closeLeaderboard = () => {
            document.getElementById('leaderboard-modal').style.display = 'none';
        };

        // --- RENDER ---
        function renderGame(data) {
            const isHost = data.hostId === myPlayerId;
            const myTurn = data.players[data.turnIndex].id === myPlayerId;
            
            const diffLabel = data.difficulty === 'easy' ? '‡∏á‡πà‡∏≤‡∏¢' : 
                              data.difficulty === 'medium' ? '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á' : '‡∏¢‡∏≤‡∏Å';
            document.getElementById('room-diff-disp').innerText = diffLabel;

            // 1. Lobby
            if (data.status === 'waiting') {
                document.getElementById('waiting-area').style.display = 'block';
                document.getElementById('game-area').style.display = 'none';
                document.getElementById('leaderboard-modal').style.display = 'none';
                document.getElementById('rank-btn').style.display = 'none';
                
                const list = document.getElementById('player-list');
                list.innerHTML = '';
                data.players.forEach(p => {
                    list.innerHTML += `
                        <div class="flex items-center justify-between bg-slate-800 p-3 rounded-lg border border-slate-700">
                            <div class="flex items-center gap-3">
                                <div class="w-4 h-4 rounded-full" style="background:${p.color}"></div>
                                <span class="text-white font-bold">${p.name}</span>
                                ${p.id === myPlayerId ? '<span class="text-xs text-green-400">(‡∏â‡∏±‡∏ô)</span>' : ''}
                            </div>
                            ${p.id === data.hostId ? 'üëë' : ''}
                        </div>
                    `;
                });

                const startBtn = document.getElementById('start-game-btn');
                const waitMsg = document.getElementById('guest-msg');
                if (isHost) {
                    startBtn.style.display = 'block';
                    waitMsg.style.display = 'none';
                    startBtn.innerText = `‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à (${data.players.length} ‡∏Ñ‡∏ô)`;
                } else {
                    startBtn.style.display = 'none';
                    waitMsg.style.display = 'block';
                }
            } 
            
            // 2. Playing OR Finished
            else {
                document.getElementById('waiting-area').style.display = 'none';
                document.getElementById('game-area').style.display = 'flex';
                document.getElementById('rank-btn').style.display = 'flex';
                
                if(document.getElementById('board').innerHTML === '') initBoard();
                renderTokens(data.players);

                const curP = data.players[data.turnIndex];
                document.getElementById('turn-text').innerHTML = `‡∏ï‡∏≤‡∏Ç‡∏≠‡∏á <span style="color:${curP.color}">${curP.name}</span>`;
                document.getElementById('log-text').innerText = data.lastAction;

                const rollBtn = document.getElementById('roll-btn');
                if (data.status === 'finished') {
                    rollBtn.disabled = true;
                    rollBtn.innerText = "‡∏à‡∏ö‡πÄ‡∏Å‡∏°‡πÅ‡∏•‡πâ‡∏ß";
                    rollBtn.className = "btn-neon w-full bg-slate-700 opacity-50";
                    showLeaderboard(data, isHost, false); 
                } else {
                    if (myTurn) {
                        rollBtn.disabled = false;
                        rollBtn.innerText = "üé≤ ‡∏™‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°";
                        rollBtn.className = "btn-neon w-full animate-pulse";
                    } else {
                        rollBtn.disabled = true;
                        rollBtn.innerText = `‡∏£‡∏≠ ${curP.name}...`;
                        rollBtn.className = "btn-neon w-full opacity-50 cursor-not-allowed";
                    }
                }
            }
        }

        function showLeaderboard(data, isHost, isViewOnly) {
            const modal = document.getElementById('leaderboard-modal');
            modal.style.display = 'flex';
            
            const lbTitle = document.getElementById('lb-title');
            const lbSub = document.getElementById('lb-sub');
            const winnerAvatar = document.getElementById('winner-avatar-container');
            const actionBtns = document.getElementById('lb-action-btns');
            const closeBtn = document.getElementById('lb-close-btn');

            const sortedPlayers = [...data.players].sort((a, b) => b.score - a.score);

            if (isViewOnly) {
                lbTitle.innerText = "‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô";
                lbTitle.className = "text-3xl font-bold text-white mb-1";
                lbSub.innerText = "‡πÉ‡∏Ñ‡∏£‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å‡πÄ‡∏¢‡∏≠‡∏∞‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î?";
                winnerAvatar.style.display = 'none';
                actionBtns.style.display = 'none';
                closeBtn.style.display = 'block';
            } else {
                const winner = sortedPlayers[0];
                lbTitle.innerText = "‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô"; 
                lbTitle.className = "text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-amber-500 mb-1";
                lbSub.innerText = `‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞: ${winner.name}`;
                
                winnerAvatar.style.display = 'flex';
                winnerAvatar.style.backgroundColor = winner.color; 
                
                actionBtns.style.display = 'flex';
                closeBtn.style.display = 'none';
                
                document.getElementById('reset-game-btn').style.display = isHost ? 'block' : 'none';
            }

            const list = document.getElementById('ranking-list');
            
            list.innerHTML = `
                <div class="grid grid-cols-4 gap-2 text-xs text-slate-400 uppercase font-bold border-b border-slate-700 pb-2 mb-2 px-2">
                    <div class="col-span-1 text-center">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</div>
                    <div class="col-span-2 text-left">‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</div>
                    <div class="col-span-1 text-right">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
                </div>
            `;
            
            sortedPlayers.forEach((p, index) => {
                let rank = index + 1;
                let medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : rank;
                
                let bgClass = 'bg-slate-800';
                let borderClass = 'border-slate-700';
                
                if (rank === 1) { borderClass = 'border-yellow-500'; bgClass = 'bg-yellow-900/20'; }
                else if (rank === 2) { borderClass = 'border-gray-400'; } 
                else if (rank === 3) { borderClass = 'border-orange-700'; }
                
                const isMe = p.id === myPlayerId ? '<span class="text-[10px] bg-white/20 px-1 rounded ml-1 text-white">‡∏Ñ‡∏∏‡∏ì</span>' : '';

                list.innerHTML += `
                    <div class="grid grid-cols-4 gap-2 items-center p-2 rounded-lg border ${borderClass} ${bgClass} mb-1">
                        <div class="col-span-1 text-center text-xl font-bold drop-shadow">${medal}</div>
                        <div class="col-span-2 flex items-center gap-2 overflow-hidden">
                            <div class="w-4 h-4 rounded-full flex-shrink-0 border border-white/20" style="background:${p.color}"></div>
                            <div class="truncate text-sm font-bold text-white">${p.name}${isMe}</div>
                        </div>
                        <div class="col-span-1 text-right font-mono text-cyan-400 font-bold text-lg">${p.score}</div>
                    </div>
                `;
            });
        }

        // --- GAMEPLAY ---
        const boardSize = 36;
        const snakes = { 14: 4, 20: 8, 32: 28, 34: 22 };
        const ladders = { 3: 16, 12: 25, 21: 33 };

        const allQuestions = {
            easy: [
                { q: "‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∏‡∏£‡∏¥‡∏¢‡∏∞‡∏Ñ‡∏∑‡∏≠?", a: ["‡πÇ‡∏•‡∏Å", "‡∏î‡∏ß‡∏á‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå", "‡∏î‡∏ß‡∏á‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå"], c: 1 },
                { q: "‡πÄ‡∏£‡∏≤‡∏≠‡∏≤‡∏®‡∏±‡∏¢‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏î‡∏≤‡∏ß‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ä‡∏∑‡πà‡∏≠?", a: ["‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£", "‡πÇ‡∏•‡∏Å", "‡∏®‡∏∏‡∏Å‡∏£‡πå"], c: 1 },
                { q: "‡∏î‡∏≤‡∏ß‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏Ñ‡∏∑‡∏≠?", a: ["‡∏î‡∏≤‡∏ß‡∏®‡∏∏‡∏Å‡∏£‡πå", "‡∏î‡∏≤‡∏ß‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£", "‡∏î‡∏≤‡∏ß‡∏û‡∏§‡∏´‡∏±‡∏™"], c: 1 },
                { q: "‡πÇ‡∏•‡∏Å‡∏°‡∏µ‡∏î‡∏ß‡∏á‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡∏Å‡∏µ‡πà‡∏î‡∏ß‡∏á?", a: ["1 ‡∏î‡∏ß‡∏á", "2 ‡∏î‡∏ß‡∏á", "‡πÑ‡∏°‡πà‡∏°‡∏µ"], c: 0 },
                { q: "‡∏î‡∏≤‡∏ß‡∏î‡∏ß‡∏á‡πÉ‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏î‡∏≤‡∏ß‡∏§‡∏Å‡∏©‡πå?", a: ["‡πÇ‡∏•‡∏Å", "‡∏î‡∏≤‡∏ß‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£", "‡∏î‡∏ß‡∏á‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå"], c: 2 },
                { q: "‡∏Å‡∏≤‡πÅ‡∏•‡πá‡∏Å‡∏ã‡∏µ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡πà‡∏≤?", a: ["‡πÅ‡∏≠‡∏ô‡∏î‡∏£‡∏≠‡∏°‡∏¥‡∏î‡∏≤", "‡∏ó‡∏≤‡∏á‡∏ä‡πâ‡∏≤‡∏á‡πÄ‡∏ú‡∏∑‡∏≠‡∏Å", "‡∏Å‡∏±‡∏á‡∏´‡∏±‡∏ô"], c: 1 },
                { q: "‡∏î‡∏≤‡∏ß‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏î‡∏ß‡∏á‡πÉ‡∏î‡∏°‡∏µ‡∏™‡∏¥‡πà‡∏á‡∏°‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï?", a: ["‡∏î‡∏≤‡∏ß‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£", "‡πÇ‡∏•‡∏Å", "‡∏î‡∏≤‡∏ß‡πÄ‡∏™‡∏≤‡∏£‡πå"], c: 1 },
                { q: "‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏Å‡∏ö‡∏¥‡∏ô‡∏≠‡∏ß‡∏Å‡∏≤‡∏®‡πÉ‡∏™‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ß‡πà‡∏≤?", a: ["‡∏ä‡∏∏‡∏î‡∏ß‡πà‡∏≤‡∏¢‡∏ô‡πâ‡∏≥", "‡∏ä‡∏∏‡∏î‡∏≠‡∏ß‡∏Å‡∏≤‡∏®", "‡∏ä‡∏∏‡∏î‡∏ô‡∏≠‡∏ô"], c: 1 },
                { q: "‡∏î‡∏ß‡∏á‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡∏°‡∏µ‡πÅ‡∏™‡∏á‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÑ‡∏´‡∏°?", a: ["‡∏°‡∏µ", "‡πÑ‡∏°‡πà‡∏°‡∏µ (‡∏™‡∏∞‡∏ó‡πâ‡∏≠‡∏ô‡πÅ‡∏™‡∏á)", "‡∏°‡∏µ‡∏ö‡∏≤‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á"], c: 1 },
                { q: "‡πÇ‡∏•‡∏Å‡∏´‡∏°‡∏∏‡∏ô‡∏£‡∏≠‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤?", a: ["1 ‡∏ß‡∏±‡∏ô", "1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", "1 ‡∏õ‡∏µ"], c: 0 }
            ],
            medium: [
                { q: "‡∏î‡∏≤‡∏ß‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏ç‡πà‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î?", a: ["‡πÇ‡∏•‡∏Å", "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ", "‡πÄ‡∏™‡∏≤‡∏£‡πå"], c: 1 },
                { q: "‡∏î‡∏≤‡∏ß‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ù‡∏≤‡πÅ‡∏ù‡∏î‡∏Ç‡∏≠‡∏á‡πÇ‡∏•‡∏Å?", a: ["‡∏î‡∏≤‡∏ß‡∏®‡∏∏‡∏Å‡∏£‡πå", "‡∏î‡∏≤‡∏ß‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£", "‡∏î‡∏≤‡∏ß‡∏û‡∏∏‡∏ò"], c: 0 },
                { q: "‡∏û‡∏≤‡∏¢‡∏∏ '‡∏à‡∏∏‡∏î‡πÅ‡∏î‡∏á‡πÉ‡∏´‡∏ç‡πà' ‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏î‡∏≤‡∏ß‡πÉ‡∏î?", a: ["‡∏î‡∏≤‡∏ß‡∏û‡∏§‡∏´‡∏±‡∏™", "‡∏î‡∏≤‡∏ß‡πÄ‡∏™‡∏≤‡∏£‡πå", "‡∏î‡∏≤‡∏ß‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£"], c: 0 },
                { q: "‡πÅ‡∏Å‡πä‡∏™‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏ô‡∏î‡∏ß‡∏á‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏Ñ‡∏∑‡∏≠?", a: ["‡πÑ‡∏Æ‡πÇ‡∏î‡∏£‡πÄ‡∏à‡∏ô", "‡∏≠‡∏≠‡∏Å‡∏ã‡∏¥‡πÄ‡∏à‡∏ô", "‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡∏≠‡∏ô"], c: 0 },
                { q: "‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏¢‡∏µ‡∏¢‡∏ö‡∏î‡∏ß‡∏á‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå?", a: ["‡∏¢‡∏π‡∏£‡∏¥ ‡∏Å‡∏≤‡∏Å‡∏≤‡∏£‡∏¥‡∏ô", "‡∏ô‡∏µ‡∏• ‡∏≠‡∏≤‡∏£‡πå‡∏°‡∏™‡∏ï‡∏£‡∏≠‡∏á", "‡∏ö‡∏±‡∏ã ‡∏≠‡∏±‡∏•‡∏î‡∏£‡∏¥‡∏ô"], c: 1 },
                { q: "‡∏î‡∏≤‡∏ß‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏î‡∏ß‡∏á‡πÉ‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏î‡∏ß‡∏á‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î?", a: ["‡∏î‡∏≤‡∏ß‡∏û‡∏∏‡∏ò", "‡∏î‡∏≤‡∏ß‡∏®‡∏∏‡∏Å‡∏£‡πå", "‡πÇ‡∏•‡∏Å"], c: 0 },
                { q: "‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∏‡∏£‡∏¥‡∏¢‡∏∞‡∏°‡∏µ‡∏î‡∏≤‡∏ß‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏µ‡πà‡∏î‡∏ß‡∏á?", a: ["7 ‡∏î‡∏ß‡∏á", "8 ‡∏î‡∏ß‡∏á", "9 ‡∏î‡∏ß‡∏á"], c: 1 },
                { q: "‡∏î‡∏≤‡∏ß‡∏´‡∏≤‡∏á‡∏Æ‡∏±‡∏•‡πÄ‡∏•‡∏¢‡πå‡πÇ‡∏Ñ‡∏à‡∏£‡∏°‡∏≤‡∏ó‡∏∏‡∏Å‡πÜ ‡∏Å‡∏µ‡πà‡∏õ‡∏µ?", a: ["50 ‡∏õ‡∏µ", "76 ‡∏õ‡∏µ", "100 ‡∏õ‡∏µ"], c: 1 },
                { q: "‡∏î‡∏≤‡∏ß‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ß‡∏á‡πÅ‡∏´‡∏ß‡∏ô‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î?", a: ["‡∏î‡∏≤‡∏ß‡πÄ‡∏™‡∏≤‡∏£‡πå", "‡∏î‡∏≤‡∏ß‡∏¢‡∏π‡πÄ‡∏£‡∏ô‡∏±‡∏™", "‡∏î‡∏≤‡∏ß‡∏û‡∏§‡∏´‡∏±‡∏™"], c: 0 }
            ],
            hard: [
                { q: "‡∏†‡∏π‡πÄ‡∏Ç‡∏≤‡πÑ‡∏ü‡πÇ‡∏≠‡∏•‡∏¥‡∏°‡∏õ‡∏±‡∏™ ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô?", a: ["‡∏î‡∏≤‡∏ß‡∏®‡∏∏‡∏Å‡∏£‡πå", "‡∏î‡∏≤‡∏ß‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£", "‡πÇ‡∏•‡∏Å"], c: 1 },
                { q: "‡∏î‡∏ß‡∏á‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå '‡πÑ‡∏ó‡∏ó‡∏±‡∏ô' ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏î‡∏≤‡∏ß‡πÉ‡∏î?", a: ["‡∏î‡∏≤‡∏ß‡∏û‡∏§‡∏´‡∏±‡∏™", "‡∏î‡∏≤‡∏ß‡πÄ‡∏™‡∏≤‡∏£‡πå", "‡∏î‡∏≤‡∏ß‡∏¢‡∏π‡πÄ‡∏£‡∏ô‡∏±‡∏™"], c: 1 },
                { q: "‡∏î‡∏≤‡∏ß‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î?", a: ["‡∏î‡∏≤‡∏ß‡∏û‡∏∏‡∏ò", "‡∏î‡∏≤‡∏ß‡∏®‡∏∏‡∏Å‡∏£‡πå", "‡∏î‡∏≤‡∏ß‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£"], c: 1 },
                { q: "‡∏î‡∏≤‡∏ß‡πÉ‡∏î‡∏´‡∏°‡∏∏‡∏ô‡∏£‡∏≠‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÅ‡∏ö‡∏ö '‡∏ï‡∏∞‡πÅ‡∏Ñ‡∏á'?", a: ["‡∏î‡∏≤‡∏ß‡πÄ‡∏ô‡∏õ‡∏à‡∏π‡∏ô", "‡∏î‡∏≤‡∏ß‡∏¢‡∏π‡πÄ‡∏£‡∏ô‡∏±‡∏™", "‡∏î‡∏≤‡∏ß‡πÄ‡∏™‡∏≤‡∏£‡πå"], c: 1 },
                { q: "‡∏Ç‡∏≠‡∏ö‡∏ü‡πâ‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå (Event Horizon) ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö?", a: ["‡∏´‡∏•‡∏∏‡∏°‡∏î‡∏≥", "‡∏î‡∏≤‡∏ß‡∏ô‡∏¥‡∏ß‡∏ï‡∏£‡∏≠‡∏ô", "‡∏ã‡∏π‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÇ‡∏ô‡∏ß‡∏≤"], c: 0 },
                { q: "‡∏î‡∏≤‡∏ß‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏î‡∏ß‡∏á‡πÉ‡∏î‡∏´‡∏°‡∏∏‡∏ô‡∏£‡∏≠‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏Ç‡πá‡∏°‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤?", a: ["‡∏î‡∏≤‡∏ß‡∏®‡∏∏‡∏Å‡∏£‡πå", "‡πÇ‡∏•‡∏Å", "‡∏î‡∏≤‡∏ß‡∏¢‡∏π‡πÄ‡∏£‡∏ô‡∏±‡∏™"], c: 0 },
                { q: "‡πÅ‡∏™‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì?", a: ["300,000 ‡∏Å‡∏°./‡∏ß‡∏¥", "1,000 ‡∏Å‡∏°./‡∏ä‡∏°.", "‡πÄ‡∏™‡∏µ‡∏¢‡∏á"], c: 0 },
                { q: "‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏°‡∏î‡∏ß‡∏á‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡πÇ‡∏•‡∏Å‡∏ä‡∏∑‡πà‡∏≠?", a: ["‡∏™‡∏õ‡∏∏‡∏ï‡∏ô‡∏¥‡∏Å 1", "‡πÄ‡∏≠‡∏Å‡∏ã‡πå‡∏û‡∏•‡∏≠‡πÄ‡∏£‡∏≠‡∏£‡πå 1", "‡πÑ‡∏ó‡∏¢‡∏Ñ‡∏°"], c: 0 },
                { q: "‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ß‡∏±‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÉ‡∏ô‡∏≠‡∏ß‡∏Å‡∏≤‡∏®‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ß‡πà‡∏≤?", a: ["‡∏Å‡∏¥‡πÇ‡∏•‡πÄ‡∏°‡∏ï‡∏£", "‡∏õ‡∏µ‡πÅ‡∏™‡∏á", "‡πÑ‡∏°‡∏•‡πå"], c: 1 }
            ]
        };

        function initBoard() {
            const b = document.getElementById('board');
            b.innerHTML = '';
            for(let i=0; i<36; i++) {
                let r = Math.floor(i/6), c = i%6;
                let num = (5-r)%2===0 ? (5-r)*6+c+1 : (5-r)*6+(5-c)+1;
                let cell = document.createElement('div');
                cell.className = "border border-white/10 flex justify-center items-center relative text-xs text-slate-500 bg-slate-900/50";
                cell.id = `c-${num}`;
                cell.innerText = num;
                if(snakes[num]) cell.innerHTML+=`<i class="fas fa-biohazard absolute text-red-500/50 text-xl"></i>`;
                if(ladders[num]) cell.innerHTML+=`<i class="fas fa-rocket absolute text-green-500/50 text-xl"></i>`;
                b.appendChild(cell);
            }
        }

        function renderTokens(players) {
            const tk = document.getElementById('tokens');
            players.forEach((p, idx) => {
                let el = document.getElementById(`t-${p.id}`);
                if (!el) {
                    el = document.createElement('div');
                    el.id = `t-${p.id}`;
                    el.className = "absolute w-8 h-8 rounded-full border-2 border-white flex justify-center items-center transition-all duration-500 shadow-lg z-10";
                    el.style.backgroundColor = p.color;
                    el.innerHTML = `<i class="fas fa-user text-black text-xs"></i>`;
                    tk.appendChild(el);
                }
                const cell = document.getElementById(`c-${p.pos}`);
                if (cell) {
                    const br = document.getElementById('board').getBoundingClientRect();
                    const cr = cell.getBoundingClientRect();
                    const offX = (idx%2)*5, offY = Math.floor(idx/2)*5;
                    el.style.transform = `translate(${cr.left-br.left+10+offX}px, ${cr.top-br.top+10+offY}px)`;
                }
            });
        }

        window.handleRoll = () => {
            const diff = gameState.difficulty || 'easy'; 
            const qList = allQuestions[diff] || allQuestions['easy'];
            const q = qList[Math.floor(Math.random()*qList.length)];

            const m = document.getElementById('q-modal');
            document.getElementById('q-text').innerText = q.q;
            document.getElementById('q-badge').innerText = diff.toUpperCase();
            document.getElementById('q-badge').className = `text-xs font-bold px-2 py-1 rounded mb-2 inline-block ${diff==='easy'?'bg-green-500/20 text-green-400':diff==='medium'?'bg-yellow-500/20 text-yellow-400':'bg-red-500/20 text-red-400'}`;

            const opts = document.getElementById('q-opts');
            opts.innerHTML = '';
            q.a.forEach((ans, i) => {
                opts.innerHTML += `<button onclick="ans(${i===q.c})" class="w-full bg-slate-700 p-3 rounded hover:bg-cyan-600 mb-2 text-left text-white">${ans}</button>`;
            });
            m.style.display = 'flex';
        };

        window.ans = async (correct) => {
            document.getElementById('q-modal').style.display = 'none';
            let curP = gameState.players[gameState.turnIndex];
            let msg = "";
            let nextPos = curP.pos;
            let earnedScore = 0;

            const newPlayers = [...gameState.players];
            // ‡∏´‡∏≤ index ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏ô array ‡πÉ‡∏´‡∏°‡πà
            const pIdx = gameState.turnIndex;

            if (!correct) {
                nextPos = Math.max(1, curP.pos - 1);
                msg = `${curP.name} ‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î! ‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á`;
                // ‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡∏•‡∏ö‡∏Å‡πá‡πÑ‡∏î‡πâ‡πÅ‡∏ï‡πà‡πÄ‡∏Å‡∏°‡∏ô‡∏µ‡πâ‡πÉ‡∏à‡∏î‡∏µ‡πÑ‡∏°‡πà‡∏•‡∏ö)
            } else {
                let dice = Math.floor(Math.random()*6)+1;
                nextPos += dice;
                earnedScore = 10; 
                msg = `${curP.name} ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (+10) ‡∏ó‡∏≠‡∏¢‡πÑ‡∏î‡πâ ${dice}`;
                
                if (nextPos > 36) nextPos = 36;
                if (snakes[nextPos]) { nextPos = snakes[nextPos]; msg+="...‡πÄ‡∏à‡∏≠‡∏´‡∏•‡∏∏‡∏°‡∏î‡∏≥!"; }
                if (ladders[nextPos]) { nextPos = ladders[nextPos]; msg+="...‡∏ß‡∏≤‡∏£‡πå‡∏õ!"; }
            }

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
            newPlayers[pIdx].score = (newPlayers[pIdx].score || 0) + earnedScore;

            let winnerId = null;
            let status = 'playing';
            
            // ‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏™‡πâ‡∏ô‡∏ä‡∏±‡∏¢ -> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Global Leaderboard
            if (nextPos === 36) {
                newPlayers[pIdx].score += 50; 
                msg = `üèÜ ${curP.name} ‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏™‡πâ‡∏ô‡∏ä‡∏±‡∏¢ (+50)! ‡∏à‡∏ö‡πÄ‡∏Å‡∏°!`;
                winnerId = curP.id; 
                status = 'finished';

                // SAVE TO GLOBAL DB WITH DIFFICULTY
                try {
                    await addDoc(getGlobalScoreRef(), {
                        name: curP.name,
                        score: newPlayers[pIdx].score,
                        difficulty: gameState.difficulty, // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å‡∏î‡πâ‡∏ß‡∏¢
                        date: serverTimestamp()
                    });
                } catch(e) { console.error("Save global score failed", e); }
            }

            newPlayers[pIdx].pos = nextPos;
            const nextTurn = (gameState.turnIndex + 1) % newPlayers.length;

            try {
                await updateDoc(getRoomRef(currentRoomId), {
                    players: newPlayers,
                    turnIndex: nextTurn,
                    lastAction: msg,
                    status: status,
                    winnerId: winnerId
                });
            } catch(e) { console.error(e); }
        };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap');
        body { font-family: 'Kanit'; background: #0f172a; color: white; }
        .btn-neon { background: #06b6d4; color: white; padding: 12px; border-radius: 10px; font-weight: bold; transition:0.2s; }
        .btn-neon:hover { background: #0891b2; transform: scale(1.02); }
        .glass { background: rgba(30, 41, 59, 0.8); border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="flex justify-center min-h-screen bg-[url('https://cdn.pixabay.com/photo/2017/08/30/01/05/milky-way-2695569_960_720.jpg')] bg-cover bg-center">

    <div id="loading-screen" class="fixed inset-0 bg-black flex flex-col justify-center items-center z-50">
        <i class="fas fa-spinner fa-spin text-4xl text-cyan-400 mb-4"></i>
        <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏à‡∏±‡∏Å‡∏£‡∏ß‡∏≤‡∏•...</p>
    </div>

    <!-- LOBBY -->
    <div id="lobby-screen" class="hidden w-full max-w-md p-6 flex-col gap-6 justify-center min-h-screen">
        <div class="text-center">
            <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-500 mb-2">Space Adventure</h1>
            <p class="text-slate-400">Solar System Edition</p>
        </div>

        <div class="glass p-6 rounded-2xl space-y-4">
            <input id="p-name-input" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" class="w-full bg-slate-800 p-3 rounded text-center border border-slate-700 focus:border-cyan-400 outline-none text-white">
            
            <div class="p-4 bg-slate-800/50 rounded-lg border border-slate-700">
                <label class="block text-sm text-slate-400 mb-2 text-left">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°:</label>
                <select id="diff-select" class="w-full bg-slate-900 p-2 rounded text-white border border-slate-600 mb-3">
                    <option value="easy">üòä ‡∏á‡πà‡∏≤‡∏¢ (‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏î‡∏≤‡∏ß‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå)</option>
                    <option value="medium" selected>ü§î ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á (‡πÄ‡∏à‡∏≤‡∏∞‡∏•‡∏∂‡∏Å)</option>
                    <option value="hard">ü§Ø ‡∏¢‡∏≤‡∏Å (‡∏î‡∏≤‡∏£‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏•‡∏∂‡∏Å‡∏ã‡∏∂‡πâ‡∏á)</option>
                </select>
                <div class="grid grid-cols-2 gap-2">
                    <button id="create-btn" onclick="createRoom()" class="btn-neon bg-gradient-to-r from-purple-600 to-pink-600 border-none">
                        <i class="fas fa-plus mr-1"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á
                    </button>
                    <button onclick="viewGlobalRankings()" class="btn-neon bg-slate-700 hover:bg-slate-600 border-none text-sm">
                        <i class="fas fa-trophy mr-1"></i> ‡∏ó‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏ö‡∏¢‡∏≠‡∏î‡∏ù‡∏µ‡∏°‡∏∑‡∏≠
                    </button>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-2">
                <button onclick="openRules()" class="btn-neon bg-blue-600 hover:bg-blue-500 border-none text-sm col-span-2">
                    üìú ‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô
                </button>
            </div>

            <div class="relative py-2"><div class="absolute inset-0 flex items-center"><div class="w-full border-t border-slate-700"></div></div><div class="relative flex justify-center"><span class="bg-slate-900 px-2 text-sm text-slate-500">‡∏´‡∏£‡∏∑‡∏≠</span></div></div>

            <div class="flex gap-2">
                <input id="room-code-input" type="text" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô" class="flex-1 bg-slate-800 p-3 rounded text-center uppercase border border-slate-700 text-white">
                <button id="join-btn" onclick="joinRoom()" class="btn-neon px-6">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</button>
            </div>
        </div>
    </div>

    <!-- GAME ROOM -->
    <div id="game-room" class="hidden w-full max-w-md p-4 flex-col gap-4 min-h-screen">
        <div class="glass p-3 rounded-xl flex justify-between items-center">
            <div>
                <p class="text-xs text-slate-400">ROOM CODE</p>
                <h2 id="room-id-disp" class="text-2xl font-bold text-cyan-400 tracking-wider">...</h2>
            </div>
            <div class="flex gap-2 items-center">
                <button id="rank-btn" onclick="viewRankings()" class="bg-yellow-500/20 text-yellow-400 px-4 py-2 rounded-lg text-sm hover:bg-yellow-500/30 transition-all font-bold hidden flex items-center gap-2">
                    <i class="fas fa-list-ol"></i> ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á
                </button>
                <div class="text-right">
                    <div id="room-diff-disp" class="text-xs text-yellow-400 font-bold mb-1">...</div>
                    <button onclick="leaveRoom()" class="bg-red-500/20 text-red-400 px-4 py-2 rounded-lg text-xs hover:bg-red-500/30 transition-all font-bold">‡∏≠‡∏≠‡∏Å</button>
                </div>
            </div>
        </div>

        <!-- Waiting -->
        <div id="waiting-area" class="glass p-6 rounded-2xl text-center space-y-4">
            <h3 class="text-xl font-bold">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡∏ö‡∏¥‡∏ô</h3>
            <div id="player-list" class="space-y-2"></div>
            
            <button id="start-game-btn" onclick="startGameHost()" class="btn-neon w-full hidden animate-bounce">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</button>
            <p id="guest-msg" class="text-slate-400 text-sm animate-pulse">‡∏£‡∏≠‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°...</p>
        </div>

        <!-- Playing -->
        <div id="game-area" class="hidden flex-col gap-4">
            <div class="relative w-full pb-[100%] bg-black/50 rounded-xl overflow-hidden border border-white/10">
                <div id="board" class="absolute inset-0 grid grid-cols-6 grid-rows-6"></div>
                <div id="tokens" class="absolute inset-0 pointer-events-none"></div>
            </div>

            <div class="glass p-4 rounded-xl text-center space-y-3">
                <div id="turn-text" class="text-lg font-bold">...</div>
                <div id="log-text" class="text-xs text-slate-400 min-h-[1.5em]">...</div>
                <button id="roll-btn" onclick="handleRoll()" class="btn-neon w-full">‡πÇ‡∏´‡∏•‡∏î...</button>
            </div>
        </div>
    </div>

    <!-- ROOM LEADERBOARD (In-game) -->
    <div id="leaderboard-modal" class="fixed inset-0 bg-black/95 z-[70] hidden justify-center items-center p-6 backdrop-blur-sm">
        <div class="glass w-full max-w-sm p-6 rounded-3xl text-center border-2 border-yellow-500/50 shadow-[0_0_50px_rgba(234,179,8,0.3)] animate-bounce-in">
            <div class="mb-4">
                <div id="winner-avatar-container" class="w-24 h-24 rounded-full mx-auto flex items-center justify-center text-5xl shadow-2xl mb-3 ring-4 ring-yellow-500 bg-white/20">
                    <i class="fas fa-trophy text-yellow-400 drop-shadow-md"></i>
                </div>
                <h2 id="lb-title" class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-amber-500">...</h2>
                <p class="text-slate-300 text-sm mt-1" id="lb-sub">...</p>
            </div>

            <div class="bg-slate-900/80 rounded-xl p-4 mb-4 max-h-[200px] overflow-y-auto border border-slate-700">
                <div id="ranking-list" class="space-y-2"></div>
            </div>

            <div class="flex flex-col gap-3">
                <div id="lb-action-btns" class="hidden flex-col gap-2 w-full">
                    <button id="reset-game-btn" onclick="resetGameHost()" class="btn-neon w-full bg-gradient-to-r from-green-500 to-emerald-600 border-none shadow-lg shadow-green-500/30">
                        <i class="fas fa-redo mr-2"></i> ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                    </button>
                    <button onclick="leaveRoom()" class="p-2 text-slate-400 hover:text-white text-sm transition-colors">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á</button>
                </div>
                <button id="lb-close-btn" onclick="closeLeaderboard()" class="btn-neon w-full bg-slate-700 hidden">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
            </div>
        </div>
    </div>

    <!-- GLOBAL LEADERBOARD MODAL -->
    <div id="global-lb-modal" class="fixed inset-0 bg-black/95 z-[80] hidden justify-center items-center p-6 backdrop-blur-sm">
        <div class="glass w-full max-w-sm p-6 rounded-3xl border-2 border-purple-500/50 shadow-[0_0_50px_rgba(168,85,247,0.3)]">
            <h2 class="text-2xl font-bold text-center text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400 mb-2">üèÜ ‡∏ó‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏ö‡∏¢‡∏≠‡∏î‡∏ù‡∏µ‡∏°‡∏∑‡∏≠</h2>
            
            <!-- Filter Dropdown -->
            <div class="flex justify-center mb-4">
                <select id="gl-diff-filter" onchange="viewGlobalRankings()" class="bg-slate-800 text-white text-sm rounded-lg p-2 border border-slate-600 focus:outline-none focus:border-purple-500">
                    <option value="all">‚≠ê ‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö</option>
                    <option value="easy">üòä ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏á‡πà‡∏≤‡∏¢</option>
                    <option value="medium">ü§î ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</option>
                    <option value="hard">ü§Ø ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏¢‡∏≤‡∏Å</option>
                </select>
            </div>

            <div class="bg-slate-900/80 rounded-xl p-4 mb-4 h-[300px] overflow-y-auto border border-slate-700" id="global-lb-list">
                <!-- Content injected here -->
            </div>
            <button onclick="closeGlobalLb()" class="btn-neon w-full bg-slate-700 hover:bg-slate-600 border-none">‡∏õ‡∏¥‡∏î</button>
        </div>
    </div>

    <!-- RULES MODAL -->
    <div id="rules-modal" class="fixed inset-0 bg-black/95 z-[90] hidden justify-center items-center p-6 backdrop-blur-sm">
        <div class="glass w-full max-w-sm p-6 rounded-3xl border-2 border-blue-500/50 shadow-[0_0_50px_rgba(59,130,246,0.3)]">
            <h2 class="text-2xl font-bold text-center text-blue-400 mb-4">üìú ‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô</h2>
            <div class="text-slate-300 text-sm space-y-3 overflow-y-auto max-h-[300px] pr-2">
                <p><strong>1. ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢:</strong> ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏ñ‡∏∂‡∏á‡∏ä‡πà‡∏≠‡∏á 36 (‡∏î‡∏≤‡∏ß‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏î) ‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ</p>
                <p><strong>2. ‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô:</strong> ‡∏ú‡∏•‡∏±‡∏î‡∏Å‡∏±‡∏ô‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
                    <br><span class="text-green-400">‚úî ‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å:</span> ‡πÑ‡∏î‡πâ‡∏ó‡∏≠‡∏¢‡πÄ‡∏ï‡πã‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤ (+10 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)
                    <br><span class="text-red-400">‚úñ ‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î:</span> ‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á 1 ‡∏ä‡πà‡∏≠‡∏á (‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)
                </p>
                <p><strong>3. ‡∏ä‡πà‡∏≠‡∏á‡∏û‡∏¥‡πÄ‡∏®‡∏©:</strong>
                    <br>üöÄ <strong>‡∏¢‡∏≤‡∏ô‡∏≠‡∏ß‡∏Å‡∏≤‡∏® (‡∏ö‡∏±‡∏ô‡πÑ‡∏î):</strong> ‡∏ß‡∏≤‡∏£‡πå‡∏õ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤
                    <br>‚ò£Ô∏è <strong>‡∏´‡∏•‡∏∏‡∏°‡∏î‡∏≥ (‡∏á‡∏π):</strong> ‡πÇ‡∏î‡∏ô‡∏î‡∏π‡∏î‡∏•‡∏á‡∏°‡∏≤‡∏Ç‡πâ‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏á
                </p>
                <p><strong>4. ‡∏Å‡∏≤‡∏£‡∏ä‡∏ô‡∏∞:</strong>
                    <br>‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏∂‡∏á‡∏ä‡πà‡∏≠‡∏á 36 ‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÇ‡∏ö‡∏ô‡∏±‡∏™ <span class="text-yellow-400">+50 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span> ‡πÅ‡∏•‡∏∞‡∏à‡∏ö‡πÄ‡∏Å‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                    <br><strong>üèÜ ‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞‡∏ï‡∏±‡∏ß‡∏à‡∏£‡∏¥‡∏á ‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡πÄ‡∏¢‡∏≠‡∏∞‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î!</strong>
                </p>
            </div>
            <button onclick="closeRules()" class="btn-neon w-full bg-slate-700 hover:bg-slate-600 border-none mt-4">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
        </div>
    </div>

    <!-- QUIZ MODAL -->
    <div id="q-modal" class="fixed inset-0 bg-black/90 z-[60] hidden justify-center items-center p-6">
        <div class="glass w-full max-w-sm p-6 rounded-2xl text-center">
            <span id="q-badge">...</span>
            <h3 class="text-xl font-bold text-cyan-400 mb-4">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°!</h3>
            <p id="q-text" class="text-lg mb-6">...</p>
            <div id="q-opts" class="space-y-2"></div>
        </div>
    </div>

</body>
</html>


